<div class="" *ngIf="isAppConfigured$ | async; else notConfigured">
  <div class="flex flex-row w-screen h-screen cursor-default" *ngIf="(recipes$ | async) as recipes">

    <div class="flex flex-col p-4 gap-y-4 recipes w-[20%]">
      <h1 class="font-bold text-2xl">{{ 'RECIPES' | transloco }}</h1>
      <input [(ngModel)]="recipeSearch" type="text" [placeholder]="'RECIPE_SEARCH_PLACEHOLDER' | transloco"
        class="bg-gray-100 text-gray-700 py-2 px-4 border border-gray-500 rounded" />
      <div class="recipe-container overflow-auto gap-y-3 h-full flex flex-col">
        <ng-container
          *ngFor="let recipe of (recipes | filterArray:recipeSearch:['name'] | orderBy:'name' || []); trackByProperty:'id'">
          <ng-container *ngTemplateOutlet="recipeTemplate; context:{ recipe, currentDay: null }"></ng-container>
        </ng-container>
      </div>
      <div class="text-xs text-center border-t px-4 pt-4">Made with ❤️ <a href="https://tailwindcss.com/"
          target="_blank">TailwindCSS</a>
        <div>by <a href="https://blog.disane.dev/en/">Disane87</a></div>
      </div>
    </div>

    <div class="flex flex-col px-4 pb-4 w-full h-screen scheduler" *ngIf="(mealPlan$ | async) as mealPlan">
      <div class="flex flex-row items-center w-full info">
        <div class="p-4 text-2xl whitespace-nowrap weeknumber justify-start w-full">
          <span>{{ 'WEEK' | transloco }}</span>: {{ currentWeek }}
        </div>
        <div class="controls flex flex-row gap-1 p-4 h-16">
          <div class="socials text-slate-400 text-2xl flex flex-row gap-2 items-center mr-3">
            <a href="https://github.com/Disane87/grocy-meal-planning" target="_blank"
              class="items-center flex flex-col"><mat-icon class="hover:text-slate-500 "
                svgIcon="github"></mat-icon></a>
            <a href="https://blog.disane.dev/en" target="_blank" class="items-center flex flex-col">
              <mat-icon class="hover:text-slate-500" svgIcon="post-outline"></mat-icon></a>
          </div>

          <select [ngModel]="selectedMealPlanSection" (ngModelChange)="selectSection($event)"
            class="bg-gray-100 text-gray-700 py-1 px-2 border border-gray-500 rounded">
            <option [ngValue]="section.id" *ngFor="let section of (mealPlanSections$ | async)">{{section.name}}</option>
          </select>

          <div class="flex flex-row gap-1 justify-end scheduler-controls">
            <button (click)="changeWeek(-1)" [title]="'PREVIOUS_WEEK' | transloco"
              class="bg-gray-100 flex flex-row items-center hover:bg-gray-500 text-gray-700 hover:text-white py-2 px-4 border border-gray-500 hover:border-transparent rounded">
              <mat-icon svgIcon="chevron-left"></mat-icon>
            </button>
            <button (click)="changeWeek(0)" [title]="'THIS_WEEK' | transloco"
              class="bg-green-100 flex flex-row items-center hover:bg-green-500 text-green-700 hover:text-white py-2 px-4 border border-green-500 hover:border-transparent rounded">
              <mat-icon svgIcon="calendar-today"></mat-icon>
            </button>
            <button (click)="changeWeek(1)" [title]="'NEXT_WEEK' | transloco"
              class="bg-gray-100 flex flex-row items-center hover:bg-gray-500 text-gray-700 hover:text-white py-2 px-4 border border-gray-500 hover:border-transparent rounded">
              <mat-icon svgIcon="chevron-right"></mat-icon>
            </button>
          </div>

        </div>
      </div>

      <div class="flex flex-row ml-4 w-full h-full divide-x planning" *ngIf="currentWeek | daysOfWeek as daysOfWeek">
        <div class="day w-1/7 hover:bg-stone-50 h-full overflow-hidden flex flex-col" *ngFor="let day of daysOfWeek"
          [ngClass]="{
          'bg-green-200': day | isToday,
          'bg-gray-100': day | isWeekend
        }">
          <div class="flex flex-col p-4 w-full text-center border-b days-header">
            <div class="w-full font-bold">{{ day | date:'EEEE' }}</div>
            {{ day | date:'longDate'}}
          </div>

          <div class="flex flex-col gap-y-2 p-4 w-full meals h-full " [id]="day.toISOString()">
            <div
              *ngFor="let plannedMeal of (mealPlan | pickObjectByValue:'day':(day | date:'yyyy-MM-dd')); trackByProperty:'id'">
              <ng-container *ngIf="plannedMeal.recipe_id | getRecipe:recipes as recipe">
                <ng-container
                  *ngTemplateOutlet="recipeTemplate; context: { recipe, currentDay: (day | date:'yyyy-MM-dd'), meal: plannedMeal }"></ng-container>
              </ng-container>
            </div>
            <div class="dropzone h-full" dndDropzone (dndDragover)="onDragover($event, day)"
              (dndDrop)="onDrop($event, day)">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #recipeTemplate let-recipe="recipe" let-currentDay="currentDay" let-meal="meal">
    <div class="max-w-sm bg-white rounded border shadow-lg group recipe hover:border-blue-400 hover:bg-blue-200"
      [class.opacity-50]="meal?.done" [class.line-through]="meal?.done" [dndDraggable]="{ recipe, meal }"
      [dndEffectAllowed]="$any(draggable.effectAllowed)" [dndDisableIf]="draggable.disable">
      <img class="w-full" *ngIf="recipe.picture_file_name"
        [src]="(('recipepictures' | grocyImage:recipe.picture_file_name) | async)" alt="Sunset in the mountains">
      <div class="px-6 py-4 w-full flex" [class.flex-col]="meal" [class.flex-row]="!meal">

        <!-- <div class="overflow-hidden w-full text-ellipsis" *ngIf="!meal && recipeSearch" [innerHTML]="recipe.name | highlightSearch:recipeSearch"></div> -->
        <!-- *ngIf="meal || !recipeSearch" -->
        <div class="overflow-hidden w-full text-ellipsis">{{ recipe.name }}</div>

        <div class="recipe-controls hidden flex-row group-hover:flex justify-between" [class.mt-4]="meal">
          <mat-icon class="text-green-400 cursor-pointer" svgIcon="check" *ngIf="meal?.done == 0"
            (click)="doneMeal(meal)"></mat-icon>

          <mat-icon class="text-red-400 cursor-pointer" svgIcon="delete-outline" *ngIf="meal && meal?.done == 0"
            (click)="deleteMeal(meal)"></mat-icon>
          <mat-icon dndHandle svgIcon="drag" class="cursor-grab"></mat-icon>
        </div>
      </div>
    </div>
  </ng-template>
</div>

<ng-template #notConfigured>
  <div class="flex flex-col justify-center items-center h-screen bg-slate-200">
    <div class="card p-4 border-slate-400 rounded justify-center flex flex-col items-center w-1/2 bg-white shadow-md ">
      <img src="assets/images/logo.png" alt="Grocy Meal Planning" class="w-1/4 justify-center items-center " />

      <h1 class="text-4xl font-bold">{{ 'CONFIG_HEADLINE' | transloco}}</h1>
      <span class="text-sm text-slate-500">{{ 'CONFIG_SUBTITLE' | transloco }}</span>

      <!-- <div class="flex flex-col gap-1 justify-center items-stretch p-4"> -->
      <form #configForm="ngForm" class="flex flex-col gap-1 justify-center items-stretch p-4">
        <input name="grocyUrl" required [(ngModel)]="grocyUrl" type="text" [placeholder]="'GROCY_URL' | transloco"
          class="bg-gray-100 text-gray-700 py-2 px-4 border border-gray-500 rounded" />

        <input name="grocyApiKey" required [(ngModel)]="grocyApiKey" type="password"
          [placeholder]="'GROCY_APP_KEY' | transloco"
          class="bg-gray-100 text-gray-700 py-2 px-4 border border-gray-500 rounded" />

        <button [disabled]="!configForm.valid" (click)="setConfig()"
          class="disabled:opacity-75 bg-green-100  gap-2 flex flex-row items-center enabled:hover:bg-green-500 text-green-700 enabled:hover:text-white py-2 px-4 border border-green-500 enabled:hover:border-transparent rounded">
          <mat-icon class="" svgIcon="check"></mat-icon> <span>{{ 'CONFIGURE' | transloco }}</span>
        </button>
      </form>

      <div class="bg-teal-100 border-t-4 border-teal-500 rounded-b text-teal-900 px-4 py-3 shadow-md" role="alert">
        <div class="flex">
          <div class="py-1"><svg class="fill-current h-6 w-6 text-teal-500 mr-4" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20">
              <path
                d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z" />
            </svg></div>
          <div>
            <p class="font-bold">{{ 'CONFIG_PRIVACY_HINT' | transloco }}</p>
            <p class="text-sm">{{ 'CONFIG_PRIVACY_HINT_TEXT' | transloco }}</p>
          </div>
        </div>
      </div>

    </div>
    <div class="socials p-4 text-slate-400 text-2xl flex flex-row gap-2">
      <a href="https://github.com/Disane87/grocy-meal-planning" target="_blank"><mat-icon class="hover:text-slate-500"
          svgIcon="github"></mat-icon></a>
      <a href="https://blog.disane.dev/en" target="_blank"><mat-icon class="hover:text-slate-500"
          svgIcon="post-outline"></mat-icon></a>
    </div>
  </div>


</ng-template>